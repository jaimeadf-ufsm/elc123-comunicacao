#pragma once
#include "LinkConnection.h"
#include <unistd.h>

#define SLIDING_WINDOW_N 4

struct Connection {
    uint8_t address;
    uint8_t sentFrame;
    uint8_t receivedFrame;
    std::string receivedMessage;
};

class Client
{
public:
    Client(const std::string& path, uint8_t address)
    {
        physicalConnection = std::make_unique<PhysicalConnection>(PhysicalConnection::Connect(path));
        linkConnection = std::make_shared<LinkConnection>(std::move(physicalConnection));
        this->address = address;
    }

    void receive()
    {
        Frame frame;

        while (true)
        {
            try
            {
                linkConnection->Receive(frame);
            }
            catch (const std::runtime_error& e)
            {
                std::cerr << "An error ocurred while receiving frame: " << e.what() << std::endl;
                break;
            }
            if (frame.DestinationAddress != address)
                continue;

            int conindex = findConnection(frame.SourceAddress);
            if (conindex == -1)
                conindex = openConnection(frame.SourceAddress);

            if (frame.ACK == 1) {
                activeConnections[conindex].sentFrame++;
            } else if (frame.ID == activeConnections[conindex].receivedFrame) {
                activeConnections[conindex].receivedFrame++;
                Frame ackFrame;
                ackFrame.DestinationAddress = frame.SourceAddress;
                ackFrame.SourceAddress = frame.DestinationAddress;
                ackFrame.Length = 0;
                ackFrame.ID = frame.ID;
                ackFrame.ACK = 1;
                std::cout << "Sending ACK Frame..." << std::endl;
                linkConnection->Send(ackFrame);
            } else {
                break;
            }

            std::cout << "Received frame." << std::endl;
            std::cout << frame << std::endl;
            std::cout << std::endl;

            printf("SentFrame: %d\nReceivedFrame: %d\n",
                    activeConnections[conindex].sentFrame,
                    activeConnections[conindex].receivedFrame);
        }
    }

    void sendMessage(std::string line, uint8_t destAddress)
    {
        int conindex = findConnection(destAddress);
        if (conindex == -1)
            conindex = openConnection(destAddress);
        int str_pos = 0;
        int frame_size = (int)line.size();
        int id = activeConnections[conindex].sentFrame;
        int init_id = id;
        while (frame_size > 0 && id < init_id + SLIDING_WINDOW_N) {
            Frame frame;
            frame.DestinationAddress = destAddress;
            frame.SourceAddress = address;
            frame.Length = std::clamp(frame_size, 0, FRAME_PAYLOAD_SIZE);
            frame.ID = id;
            frame.ACK = 0;
            std::memcpy(frame.Payload, &line.data()[str_pos], frame.Length);
            frameBuffer.pushback(frame);
            str_pos += FRAME_PAYLOAD_SIZE;
            frame_size -= FRAME_PAYLOAD_SIZE;
            id++;
        }
        for (int i = 0; i < std::max(SLIDING_WINDOW_N, frameBuffer.size(); i++) {
            std::cout << "Sending frame..." << std::endl;
            std::cout << frameBuffer[i] << std::endl;
            std::cout << std::endl;
       
            linkConnection->Send(frameBuffer[i]);
        }
    }

    void run()
    {
        std::thread thread(
            [this]()
            {
                this->receive();
            }
        );
        std::string line;
        while (std::getline(std::cin, line)) {
            if (line.empty())
                continue;
            
            size_t pos = line.find(" ");
            std::string command = line.substr(0, pos);
            line.erase(0, pos + 1);
            
            if (!command.compare("send")) {
                size_t pos = line.find(" ");
                uint8_t destAddress = 0;
                try {
                    destAddress = std::stoi(line.substr(0, pos));
                } catch (const std::exception& e) {
                    std::cerr << "Invalid address: " << e.what() << std::endl;
                    continue;
                }
                line.erase(0, pos + 1);
                sendMessage(line, destAddress);
            } else {
                std::cout << "Invalid command\n";
            }
        }
    }

private:
    uint8_t address;
    std::unique_ptr<PhysicalConnection> physicalConnection;
    std::shared_ptr<LinkConnection> linkConnection;
    std::vector<struct Connection> activeConnections;
    std::vector<Frame> frameBuffer;

    int findConnection(uint8_t address)
    {
        int i;
        for (i = 0; i < activeConnections.size(); i++) {
            printf("%d %d\n", i, activeConnections[i].address);
            if (activeConnections[i].address == address)
                return i;
        }
        return -1;
    }

    int openConnection(uint8_t address)
    {
        struct Connection c;
        c.address = address;
        c.sentFrame = 0;
        c.receivedFrame = 0;
        activeConnections.push_back(c);
        return (int)activeConnections.size() - 1;
    }
};
